services:
  mictlanx-router-0:
    image: nachocode/mictlanx:router
    container_name:  mictlanx-router-0
    environment:
      - TEZCANALYTICX_ENABLED=${TEZCANALYTICX_ENABLED:-0}
      - TEZCANALYTICX_FLUSH_TIMEOUT=${TEZCANALYTICX_FLUSH_TIMEOUT:-10s}
      - TEZCANALYTICX_BUFFER_SIZE=${TEZCANALYTICX_BUFFER_SIZE:-100}
      - TEZCANALYTICX_PATH=${TEZCANALYTICX_PATH:-/api/v4/events/}
      - TEZCANALYTICX_PORT=${TEZCANALYTICX_PORT:-45000}
      - TEZCANALYTICX_HOSTNAME=${TEZCANALYTICX_HOSTNAME:-localhost}
      - TEZCANALYTICX_LEVEL=${TEZCANALYTICX_LEVEL:-0}
      - TEZCANALYTICX_PROTOCOL=${TEZCANALYTICX_PROTOCOL:-http}
      - LOG_PATH=${LOG_PATH:-/log}

      - MICTLANX_ROUTER_HOST=${MICTLANX_ROUTER_HOST:-localhost}
      - MICTLANX_ROUTER_PORT=${MICTLANX_ROUTER_PORT:-60666}
      - MICTLANX_ROUTER_RELOAD=${MICTLANX_ROUTER_RELOAD:-1}
      - MICTLANX_ROUTER_MAX_WORKERS=${MICTLANX_ROUTER_MAX_WORKERS:-4}
      - MICTLANX_ROUTER_LB_ALGORITHM=${MICTLANX_ROUTER_LB_ALGORITHM:-ROUND_ROBIN}
      - MICTLANX_ROUTER_LOG_NAME=${MICTLANX_ROUTER_LOG_NAME:-mictlanx-router-0}
      - MICTLANX_ROUTER_LOG_INTERVAL=${MICTLANX_ROUTER_LOG_INTERVAL:-24}
      - MICTLANX_ROUTER_LOG_WHEN=${MICTLANX_ROUTER_LOG_WHEN:-h}
      - MICTLANX_ROUTER_LOG_SHOW=${MICTLANX_ROUTER_LOG_SHOW:-1}
      - MICTLANX_ROUTER_REPLICATOR_QUEUE_MAXSIZE=${MICTLANX_ROUTER_REPLICATOR_QUEUE_MAXSIZE:-100}
      - MICTLANX_ROUTER_PEER_HEALER_HEARTBEAT=${MICTLANX_ROUTER_PEER_HEALER_HEARTBEAT:-1m}
      - MICTLANX_ROUTER_REPLICATOR_QUEUE_TIMEOUT=${MICTLANX_ROUTER_REPLICATOR_QUEUE_TIMEOUT:-30s}
      - MICTLANX_ROUTER_SYNC_FAST=${MICTLANX_ROUTER_SYNC_FAST:-1}
      - MICTLANX_ROUTER_PEER_BASE_PORT=${MICTLANX_ROUTER_PEER_BASE_PORT:-25000}
      - MICTLANX_ROUTER_MAX_PEERS=${MICTLANX_ROUTER_MAX_PEERS:-10}
      - MICTLANX_ROUTER_MAX_TTL=${MICTLANX_ROUTER_MAX_TTL:-3}
      - MICTLANX_ROUTER_AVAILABLE_NODES=${MICTLANX_ROUTER_AVAILABLE_NODES:-0;1;2;3;4;5;6;7;8;9;10}
      - MICTLANX_ROUTER_MAX_AFTER_ELASTICITY=${MICTLANX_ROUTER_MAX_AFTER_ELASTICITY:-10}
      - MICTLANX_ROUTER_SHOW_REPLICATOR_LOGS=${MICTLANX_ROUTER_SHOW_REPLICATOR_LOGS:-1}
      - MICTLANX_ROUTER_DELAY=${MICTLANX_ROUTER_DELAY:-2s}
      - MICTLANX_ROUTER_MAX_TRIES=${MICTLANX_ROUTER_MAX_TRIES:-60}
      - MICTLANX_ROUTER_MAX_TASKS=${MICTLANX_ROUTER_MAX_TASKS:-100}
      - MICTLANX_ROUTER_MAX_CONCURRENCY=${MICTLANX_ROUTER_MAX_CONCURRENCY:-5}
      - MICTLANX_ROUTER_MAX_PEERS_RF=${MICTLANX_ROUTER_MAX_PEERS_RF:-5}
      - MICTLANX_ROUTER_NETWORK_ID=${MICTLANX_ROUTER_NETWORK_ID:-mictlanx}
      - MICTLANX_ROUTER_BASE_PROTOCOL=${MICTLANX_ROUTER_BASE_PROTOCOL:-http}

      - MICTLANX_SPM_SHOW_LOGS=${MICTLANX_SPM_SHOW_LOGS:-1}
      - MICTLANX_SPM_DEBUG=${MICTLANX_SPM_DEBUG:-1}
      - MICTLANX_SPM_MAX_TRIES=${MICTLANX_SPM_MAX_TRIES:-10}
      - MICTLANX_SPM_MAX_TIMEOUT_TO_RECOVER=${MICTLANX_SPM_MAX_TIMEOUT_TO_RECOVER:-30s}
      - MICTLANX_SPM_PHYSICAL_NODES_SEPARATOR=${MICTLANX_SPM_PHYSICAL_NODES_SEPARATOR:-;}
      - MICTLANX_SPM_PHYSICAL_NODES_INDEXES=${MICTLANX_SPM_PHYSICAL_NODES_INDEXES:-0;2;3;4;5}
      - MICTLANX_SPM_MAX_IDLE_TIME=${MICTLANX_SPM_MAX_IDLE_TIME:-60s}
      - MICTLANX_SPM_QUEUE_TICK_TIMEOUT=${MICTLANX_SPM_QUEUE_TICK_TIMEOUT:-5s}
      - MICTLANX_SPM_PEER_CONFIG_PATH=${MICTLANX_SPM_PEER_CONFIG_PATH:-/not/found/x.json}
      - MICTLANX_SPM_PEER_CONFIG_MAX_TIMEOUT_TO_SAVE=${MICTLANX_SPM_PEER_CONFIG_MAX_TIMEOUT_TO_SAVE:-20m}
      - MICTLANX_SPM_MAX_RECOVER_TIME_UTIL_RESTART=${MICTLANX_SPM_MAX_RECOVER_TIME_UTIL_RESTART:30s}

      - MICTLANX_RM_ELASTIC=${MICTLANX_RM_ELASTIC:-0}
      - MICTLANX_RM_SHOW_LOGS=${MICTLANX_RM_SHOW_LOGS:-1}
      - MICTLANX_RM_QUEUE_TICK_TIMEOUT=${MICTLANX_RM_QUEUE_TICK_TIMEOUT:-5s}
      - MICTLANX_RM_QUEUE_MAX_IDLE_TIME=${MICTLANX_RM_QUEUE_MAX_IDLE_TIME:-30s}
      - MICTLANX_PEERS_STR=${MICTLANX_PEERS_STR:-mictlanx-peer-0:mictlanx-peer-0:25000 mictlanx-peer-1:mictlanx-peer-1:25001 mictlanx-peer-2:mictlanx-peer-2:25002}
      - MICTLANX_PROTOCOL=${MICTLANX_PROTOCOL:-http}
      - MICTLANX_API_VERSION=${MICTLANX_API_VERSION:-4}
      - MICTLANX_TIMEOUT=${MICTLANX_TIMEOUT:-3600}
      - MICTLANX_SUMMONER_API_VERSION=${MICTLANX_SUMMONER_API_VERSION:-3}
      - MICTLANX_SUMMONER_IP_ADDR=${MICTLANX_SUMMONER_IP_ADDR:-localhost}
      - MICTLANX_SUMMONER_PORT=${MICTLANX_SUMMONER_PORT:-15000}
      - MICTLANX_SUMMONER_MODE=${MICTLANX_SUMMONER_MODE:-swarm}
      - MICTLANX_SUMMONER_SUBNET=${MICTLANX_SUMMONER_SUBNET:-10.0.0.0/25}
    command: uvicorn mictlanxrouter.server:app --host ${MICTLANX_ROUTER_HOST-0.0.0.0} --port ${MICTLANX_ROUTER_PORT-60666}
    ports:
      - ${MICTLANX_ROUTER_PORT-60666}:${MICTLANX_ROUTER_PORT-60666}
    volumes:
      - mictlanx-router-0_logs:/log
      - ./peers.json:/app/peers.json
    networks:
      - mictlanx
    restart: unless-stopped


  mictlanx-summoner-0:
    image: nachocode/mictlanx:summoner
    container_name: mictlanx-summoner-0
    hostname: mictlanx-summoner-0
    privileged: true
    ports:
      - 15000:15000
    environment:
      - USER_ID=1001
      - GROUP_ID=1002
      - DOCKER_GID=1001
      - BASE_PATH=${BASE_PATH-/app/mictlanx}
      - BIN_NAME=summoner
      - NODE_ID=mictlanx-summoner-0
      - NODE_PORT=15000
      - IP_ADDRESS=mictlanx-summoner-0
      - SERVER_IP_ADDR=0.0.0.0
      - LOG_PATH=${BASE_PATH-/app/mictlanx}/log
      - LOCAL_PATH=${BASE_PATH-/app/mictlanx}/local
      - DATA_PATH=${BASE_PATH-/app/mictlanx}/data
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - mictlanx-summoner-0:/mictlanx
    networks:
      - mictlanx

  tezcanalyticx-0:
    image: nachocode/tezcanalyticx:api
    container_name:  tezcanalyticx-0
    environment:
    - LOGGER_PATH=/log
    - IP_ADDR=0.0.0.0
    - PORT=45000
    - RELOAD=1
    - PERIOD_WINDOW_TIME_SEC=30s
    - LOGGER_INTERVAL=24
    - LOGGER_WHEN=h
    command: uvicorn tezcanalyticx.server:app --host ${TEZCANALYTICX_IP_ADDR-0.0.0.0} --port ${TEZCANALYTICX_PORT-45000}
    ports:
    - ${PORT-45000}:${PORT-45000}
    volumes:
    - tezcanalyticx-0:/log
    networks:
    - mictlanx
    restart: unless-stopped
volumes:
  mictlanx-router-0_logs:
  tezcanalyticx-0:
  mictlanx-summoner-0:

networks:
  mictlanx:
    external: true
